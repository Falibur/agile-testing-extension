<!-- Copyright Mike Anderson 2011 -->

<html>
<head>

<link href="styles.css" media="screen" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="scripts/utilities.js"></script>
<script type="text/javascript" src="scripts/urban_airship.js"></script>
<script type="text/javascript" src="scripts/cloudant.js"></script>

<script>

// If we don't have a device token set then redirect to options page
if(!localStorage.deviceToken){
  chrome.tabs.create( {url: chrome.extension.getURL("options.html")});
} else{
  airship = new UrbanAirship({deviceToken: localStorage.deviceToken});
}

// Cloudant schema
// {
//   alert: 'alert text',
//   httpUrl: 'http URL of page',
//   appUrl: 'app URL for the object'
// }


PushNotification = function(construct){
  this.data = {}
  this.data.alert      = construct.alert
  this.data.httpUrl    = construct.httpUrl
  this.data.appUrl     = construct.appUrl
  this.data.faviconUrl = construct.faviconUrl
}

PushNotification.prototype.submit = function(){
  var self = this;
  Cloudant.create(self.data, function(response){
    // Finish setting up the payload here
    airship.payload.aps.alert = self.data.alert
    airship.payload.aps.key   = response.id
    airship.sendNotification();
  })
}


var Yelp = {
  test:     function(url){ return /yelp.com.biz/.test(url) },
  convert: function(url, pn){ pn.data.appUrl = "yelp://"+ url.split(".com")[1] }
}

var Gmaps = {
  test: function(url){ return /maps.google/.test(url) },
  convert: function(url, pn){ pn.data.appUrl = url; }
}

var Rdio = {
  test: function(url){ return /rdio.com/.test(url) },
  convert: function(url, pn){ 
    $.getJSON("http://www.rdio.com/api/oembed/?url=" + escape(url), function(data){
      url_string = $(data.html).attr('src')
      url_string = url_string.replace(/^http/, "rdio")
      url_string = url_string.replace(/\/?\?.*/,"") // Get rid of the search string
      url_string = url_string.replace(/\/\w\//, "/x/") // for whatever weird reason this must be an "x"
      pn.data.appUrl = url_string
    })
  }
}

var Instagram = {
  test: function(url){ return /instagr.am/.test(url) },
  convert: function(url, pn){ 
    $.getJSON("http://api.instagram.com/oembed?url=" + escape(url), function(data) {
        pn.data.appUrl = "instagram://media?id=" + data.media_id
      })
  }
}

var linkouts = [Yelp, Gmaps, Instagram, Rdio]


chrome.tabs.getSelected(null, function(tab) {
  selected = tab;
  
  chrome.tabs.sendRequest(tab.id, {action:'start', tabId: tab.id}, function(response) {  
      // TODO: support Rdio (done), Yelp (done), Instagram (done), Path, Pinterest, Google maps (done), Youtube (done), Ebay
      
      title   = response.title || selected.title;
      url     = response.url   || selected.url;
      tabHTML = response.html;
      favicon = selected.favIconUrl;
      appUrl  = ""
            
      pn = new PushNotification({alert: title, httpUrl: url, appUrl: appUrl, faviconUrl: favicon})
                  
      for(key in linkouts)
      {
        // Get the linkout
        linkout = linkouts[key]
        if(linkout.test(url)) {
          // set the appURL on the push notification
          linkout.convert(url, pn);
        }
      }
      
      // Add any other converters here... 

      item = $("<li><img src='" + favicon + "'/><a rel='phonepush' href='#'>" + title + "</a></li>")
      item.find("a").data("pn", pn)
      $("#entries").append(item)
      
      // PHONE NUMBERS
      phone_numbers = response.phones
      if(phone_numbers != null){
        for(key in phone_numbers)
        {
          phone_number = phone_numbers[key]
          phone_url = "tel:" + phone_number.replace(/[\(\) ]/g, "")
          pn = new PushNotification({alert: phone_number, httpUrl: "", appUrl: phone_url, faviconUrl: "..."})
          
          item = $("<li><img src='assets/HiResPhone.png'/><a rel='phonepush' href='#'>" + phone_number + "</a></li>")
          item.find("a").data("pn", pn);
          $("#entries").append(item)
        }
      }
            
      if(response.appstoreUrl != null){
        // TODO: grab the name of this app from the URL
        
        pn = new PushNotification({alert: "App download", httpUrl: "", appUrl: response.appstoreUrl, faviconUrl: "..."});
        
        item = $("<li><img src='assets/iosicon.png'/><a rel='phonepush' href='#'>Download app</a></li>")
        item.find("a").data("pn", pn);
        $("#entries").append(item)
      }
      
      // Look for any maps on the page
      
      // Todo...
  });
});

$("[rel='phonepush']").live('click', function(e){
  pn = $(this).data("pn")
  e.stopPropagation();
  pn.submit();
})

</script>

<style>
 li img {
   width: 16px;
   height: 16px;
   float: left;
   margin-right: 5px;
 }
 
 li a {
   float: left;
   text-decoration: none;
   width: 90%;
 }
 
 li a:hover{
   text-decoration: underline;
 }
 
 li {
   list-style-type:none;
   clear: right;
   overflow: auto;
   padding-bottom: 0.75em;
 }
</style>

</head>

<body>
<div class="header">
  <h1>Push Mobile</h1>
</div>

<div class="content">
	<div class="tools">	
		  <ul id="entries">
		  </ul>
	</div>

</div>
<div class="footer">
  <span id="errorMsg" class="status error" style="display:none">Error, please refresh and try again</span>
</div>
</body>
</html>